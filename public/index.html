<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link href="https://fonts.googleapis.com/css?family=Roboto:300,400" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">
        <style>
            * {
                box-sizing: border-box;
                font-family: 'Roboto', sans-serif;
                font-weight: 400;
                color: white;
            }

            html, body {
                height: 100%;
            }

            body {
                background: rgb(24, 25, 25);
                height: 100%;
                margin: 0;
                padding: 0;
            }

            ul, li {
                list-style: none;
                padding: 0;
                margin: 0;
            }

            aside {
                width: 300px;
                float: left;
                padding-top: 50px;
            }

            aside li {
                margin: 25px;
                padding: 25px;
                font-size: 14px;
            }

            aside li.new {
                padding: 0;
                position: fixed;
                bottom: 0;
                width: 250px;
            }

            aside li.new input[type="text"] {
                line-height: 50px;
                color: rgb(36,37,37);
                padding: 0 25px;
                width: 100%;
            }

            aside li.new input[type="submit"] {
                line-height: 50px;
                color: white;
                padding: 0 25px;
                width: 100%;
                background: rgb(0, 89, 149);
                border: 0;
            }

            aside li.new input[type="submit"]:hover {
                opacity: 0.5;
            }

            aside li.server {
                background: rgb(0, 89, 149);
                opacity: 0.3;
                cursor: pointer;
            }

            aside li.server:not(.active).newMessage {
                animation-name: newMessage;
                animation-duration: 1.5s;
            }

            @keyframes newMessage {
                0% { opacity: 0.3; }
                20% { opacity: 1; }
                40% { opacity: 0.3; }
                60% { opacity: 1; }
                80% { opacity: 0.3; }
                90% { opacity: 1; }
                100% { opacity: 0.3; }
            }

            aside li.server.active {
                opacity: 1;
                cursor: auto;
            }

            main {
                background: rgb(36,37,37);
                height: 100%;
                margin-left: 300px;
            }

            main .console {
                display: none;
            }

            main .console.active {
                display: block;
            }

            main h1 {
                margin: 0;
                color: white;
                font-size: 20px;
                line-height: 50px;
            }

            main .header {
                background: rgb(0, 89, 149);
                padding: 0 25px;
                height: 50px;
            }

            main ul {
                overflow-y: auto;
                max-height: calc(100% - 50px);
            }

            main li {
                background: rgb(58, 58, 59);
                margin: 25px;
                padding: 10px;
            }

            main li.server {
                text-align: right;
            }

            main li h2 {
                font-size: 14px;
                padding: 0;
                margin: 0;
                top: -15px;
                position: relative;
            }

            main li h2.info {
                background: rgb(0, 89, 149);
                display: inline;
                padding: 5px;
            }

            main li pre {
                font-size: 13px;
                padding: 0;
                margin: 10px 0 0;
                font-family: 'Roboto Mono', monospace;
            }
        </style>
    </head>
    <body>
        <aside>
            <ul>
                <li class="new">
                    <form action="#">
                        <input type="text" name="uri" placeholder="tcp://127.0.0.1:1337">
                        <input type="submit" value="Start new server">
                    </form>
                </li>
            </ul>
        </aside>
        <main></main>
        <script>
            const connection = new WebSocket('ws://127.0.0.1:8080/live');

            connection.addEventListener('message', function(message) {
                handleNewMessage(JSON.parse(message.data));
            });

            connection.addEventListener('open', function() {
                document.querySelector('li.new form').addEventListener('submit', function(e) {
                    e.preventDefault();

                    connection.send(document.querySelector('li.new form input[type="text"]').value);
                });
            });

            function handleNewMessage(message) {
                const container = getConsole(message.server);
                const list      = container.querySelector('ul');
                const item      = document.createElement('li');
                const pre       = document.createElement('pre');

                item.classList.add('client');

                pre.textContent = message.message;

                const label = document.createElement('h2');

                label.classList.add('info');

                if (['server', 'outgoing'].indexOf(message.category) > -1) {
                    item.classList.add('server');

                    label.textContent = 'Server';
                } else {
                    item.classList.add('client');

                    label.textContent = 'Client';
                }

                item.appendChild(label);

                item.appendChild(pre);

                list.appendChild(item);

                const listItem = document.querySelector('aside li[data-server="' + message.server + '"]');

                listItem.classList.add('newMessage');

                setTimeout(function() {
                    listItem.classList.remove('newMessage');
                }, 1000);

                list.scrollTop = list.scrollHeight;
            }

            function getConsole(server) {
                if (document.querySelector('.console[data-server="' + server + '"]')) {
                    return document.querySelector('.console[data-server="' + server + '"]');
                }

                createListItem(server);

                const container = document.createElement('div');
                const header    = document.createElement('div');
                const h1        = document.createElement('h1');
                const list      = document.createElement('ul');

                h1.textContent = server;

                header.classList.add('header');

                header.appendChild(h1);

                container.classList.add('console');

                container.appendChild(header);
                container.appendChild(list);

                container.dataset.server = server;

                document.querySelector('main').appendChild(container);

                document.querySelectorAll('main .console').forEach(function(item) {
                    item.classList.remove('active');
                });

                container.classList.add('active');

                return container;
            }

            function createListItem(server) {
                const list = document.querySelector('aside ul');
                const item = document.createElement('li');

                item.classList.add('server', 'active');

                item.textContent = server;

                item.dataset.server = server;

                document.querySelectorAll('aside ul li.server').forEach(function(serverItem) {
                    serverItem.classList.remove('active');
                });

                item.classList.add('active');

                list.appendChild(item);
            }

            document.querySelector('aside ul').addEventListener('click', function(e) {
                const target = e.target;

                if (target.tagName !== 'LI' || !target.classList.contains('server') || target.classList.contains('active')) {
                    return;
                }

                document.querySelectorAll('aside ul li.active').forEach(function(item) {
                    item.classList.remove('active');
                });

                target.classList.add('active');

                if (document.querySelector('.console.active')) {
                    document.querySelector('.console.active').classList.remove('active');
                }

                document.querySelector('.console[data-server="' + target.textContent + '"]').classList.add('active');
            });
        </script>
    </body>
</html>
